---
id: 11
title: WCF Performance Optimization Tips
date: 2008-10-17T10:48:50+00:00


guid: /post/2008/10/WCF-Performance-Optimization-Tips.aspx
permalink: /2008/10/wcf-performance-optimization-tips/
dsq_thread_id:
  - "77712425"
categories:
  - .NET
---
<p>I wound up work on my last project and thought of sharing some performance challenges we faced when the product went live.</p>  <p>Keep in mind though that optimization options heavily rely on your application design and its usage scenarios.</p>  <p><strong>Usage Scenario</strong></p>  <p>The usage scenario for which the following optimizations worked are as follows. The WCF services are hosted under IIS and currently only serve requests that come from the desktop client application through the intranet. Roughly 300 instances of the client application will be used concurrently.</p>  <p>   <br /><strong>Long running calls      <br /></strong>The application design used the BackgroundWorker when making calls to the server but the actual WCF call was synchronous. Synchronous calls work well in most scenarios but when your service performs a long running task (&gt;1 sec) it blocks other clients from connecting to the server. Asynchronous calls make better sense in this scenario.     <br />Ref: <a href="http://msdn.microsoft.com/en-us/library/ms734701.aspx">Synchronous and Asynchronous Operations</a> </p>  <p><strong>Bindings      <br /></strong>When designing your application pick the binding carefully as this also affects performance. The WCF services were initially designed to use WSHttpBinding. This binding though affects performance especially when options such as security, reliable sessions and transaction flow are enabled. </p>  <p>As part of the performance tuning we switched to using BasicHttpBinding as none of the WS features were actually being used by the application. This dramatically improved performance because we cut down on all the acknowledgements. </p>  <p>&#160;</p>  <table border="0" cellspacing="0" cellpadding="2" width="400"><tbody>     <tr>       <td valign="top">Default WSHttpBinding          <br />with Reliable Session Enabled (9 messages)</td>        <td valign="top">BasicHttpBinding (2 messages)</td>     </tr>      <tr>       <td valign="top"><img style="display: inline" title="WsHttpBinding-Messages" border="0" alt="WsHttpBinding-Messages" src="{{ site.url }}{{ site.baseurl }}/wp-content/uploads/binary/WCFPerformanceOptimizationTips_7C4A/WsHttpBindingMessages.jpg" width="388" height="264" /> </td>        <td valign="top"><img style="display: inline" title="BasicBinding-Messages" border="0" alt="BasicBinding-Messages" src="{{ site.url }}{{ site.baseurl }}/wp-content/uploads/binary/WCFPerformanceOptimizationTips_7C4A/BasicBindingMessages.jpg" width="388" height="197" /> </td>     </tr>   </tbody></table>  <p>&#160;&#160; </p>  <p>The security we lost when switching over to BasicHttpBinding will be enforced at the network level by locking down the machines that are allowed to make calls to the service. </p>  <p>In our case we could have squeezed out more performance if we had used NetTcpBinding but that would have required IIS7 and WAS. </p>  <p>Ref:    <br />-&#160;&#160;&#160; <a href="http://www.pluralsight.com/community/blogs/aaron/archive/2007/03/22/46560.aspx">WCF Binding Comparison</a>     <br />-&#160;&#160;&#160; <a href="http://geekswithblogs.net/claeyskurt/archive/2008/04/22/121508.aspx">BasicHttpBinding compared to WSHttpBinding at SOAP packet level</a> [Note: Although this author recommends WS over Basic, Microsoft specifies that the secure and reliable sessions be disabled for Load Balanced environments which basically brings it down to Basic].     <br />-&#160;&#160;&#160; <a href="http://msdn.microsoft.com/en-us/library/ms730128.aspx">Load Balancing</a> </p>  <p><strong>Service Model Throttling      <br /></strong>The service throttling parameters are another key element to look at when performance tuning services. The name is a little misleading though as it tends to imply that you want to throttle your service when in fact these are the default settings that the Microsoft engineers have put in place to prevent DOS attacks against your service. </p>  <p>In our case due to the nature of our application usage these settings caused the server to queue new requests once the default throttling levels of 10 concurrent sessions were reached. What effectively happened was that once long running queries were being processed other requests started getting queued up even though the server memory and processor usage were very low. </p>  <p>The resolution for this was to increase the default values for these settings (shown below) to a few thousand. </p>  <div>   <div style="border-bottom-style: none; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: consolas, &#39;Courier New&#39;, courier, monospace; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">     <pre style="border-bottom-style: none; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: consolas, &#39;Courier New&#39;, courier, monospace; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">&lt;</span><span style="color: #800000">behaviors</span><span style="color: #0000ff">&gt;</span> </pre>

    <pre style="border-bottom-style: none; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: consolas, &#39;Courier New&#39;, courier, monospace; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">  <span style="color: #0000ff">&lt;</span><span style="color: #800000">serviceBehaviors</span><span style="color: #0000ff">&gt;</span> </pre>

    <pre style="border-bottom-style: none; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: consolas, &#39;Courier New&#39;, courier, monospace; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">&lt;</span><span style="color: #800000">behavior</span> <span style="color: #ff0000">name</span><span style="color: #0000ff">=&quot;DefaultThrottlingBehavior&quot;</span><span style="color: #0000ff">&gt;</span> </pre>

    <pre style="border-bottom-style: none; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: consolas, &#39;Courier New&#39;, courier, monospace; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">      <span style="color: #0000ff">&lt;</span><span style="color: #800000">serviceThrottling</span> <span style="color: #ff0000">maxConcurrentCalls</span><span style="color: #0000ff">=&quot;16&quot;</span> </pre>

    <pre style="border-bottom-style: none; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: consolas, &#39;Courier New&#39;, courier, monospace; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">                         <span style="color: #ff0000">maxConcurrentSessions</span><span style="color: #0000ff">=&quot;10&quot;</span> </pre>

    <pre style="border-bottom-style: none; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: consolas, &#39;Courier New&#39;, courier, monospace; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">                         <span style="color: #ff0000">maxConcurrentInstances</span><span style="color: #0000ff">=&quot;[Int32.MaxValue]&quot;</span> <span style="color: #0000ff">/&gt;</span> </pre>

    <pre style="border-bottom-style: none; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: consolas, &#39;Courier New&#39;, courier, monospace; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">&lt;/</span><span style="color: #800000">behavior</span><span style="color: #0000ff">&gt;</span> </pre>

    <pre style="border-bottom-style: none; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: consolas, &#39;Courier New&#39;, courier, monospace; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">  <span style="color: #0000ff">&lt;/</span><span style="color: #800000">serviceBehaviors</span><span style="color: #0000ff">&gt;</span> </pre>

    <pre style="border-bottom-style: none; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: consolas, &#39;Courier New&#39;, courier, monospace; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">&lt;/</span><span style="color: #800000">behaviors</span><span style="color: #0000ff">&gt;</span> </pre>
  </div>
</div>

<p>
  <br />Ref: 

  <br />-&#160;&#160;&#160; <a href="http://msdn.microsoft.com/en-us/library/ms731379.aspx">&lt;serviceThrottling&gt;</a> 

  <br />-&#160;&#160;&#160; <a href="http://msdn.microsoft.com/en-us/library/ms735114(VS.85).aspx">Using ServiceThrottlingBehavior to Control WCF Service Performance</a> </p>

<p><strong>General guidelines when tuning performance </strong></p>

<p><u>Benchmarks 
    <br /></u>When tasked with tuning for performance the first requirement is to establish benchmarks on the current service levels and the expected service level once the tuning is completed. </p>

<p><u>Identify the bottleneck 
    <br /></u>The next key point is to identify the area that is causing the bottleneck. For the WCF services we tracked the time taken on the client side against the actual execution of the web service to eliminate the network being the bottleneck. 

  <br />We worked backwards from the database call to ensure that they completed within the specified time. </p>

<p>Having your application instrumented is a key part of the initial design. The Enterprise Library provides instrumentation and open source tools such as log4net are lightweight and effective as well. </p>

<p><u>Replicate in your dev environment 
    <br /></u>Effectively testing out any tuning options can only be done if you can repro the issue in your development environment. The built-in load tester in Visual Studio will be a key part of your load testing armoury. </p>

<p><u>Code Profiling 
    <br /></u>If the bottleneck points to your code, code profiling tools will help your isolate the problem areas. At the time of this writing <a href="http://www.red-gate.com/Products/ants_profiler/index.htm">Red Gate ANTS Profiler</a> and <a href="http://www.jetbrains.com/profiler/">JetBrains dotTrace</a> are capable solutions. The code profiler built into Visual Studio 2008 is not as effective as these tools.</p>

<p></p>

<p>Finally a shout-out to WCF MVP <a href="http://geeksdiary.com/">Buddhike</a> who saved my day by quickly pointing me towards the binding and security modes as the perf culprits.</p>